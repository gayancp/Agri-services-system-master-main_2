<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orders Page - Test Update & Delete Functions</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        /* Custom styles for better presentation */
        .modal-backdrop {
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Mock data for testing
        const mockBookings = [
            {
                _id: '1',
                bookingNumber: 'BK123456789',
                status: 'pending_confirmation',
                serviceDetails: {
                    title: 'Crop Irrigation Service',
                    serviceType: 'irrigation'
                },
                booking: {
                    date: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000), // 2 days from now
                    time: '09:00'
                },
                pricing: {
                    currency: 'LKR',
                    finalAmount: 5000
                },
                payment: {
                    transactionId: 'TXN123456',
                    method: 'card',
                    status: 'paid'
                },
                customer: {
                    _id: 'user1',
                    firstName: 'John',
                    lastName: 'Doe',
                    email: 'john@example.com'
                },
                serviceProvider: {
                    firstName: 'Service',
                    lastName: 'Provider',
                    email: 'provider@example.com',
                    phone: '+94712345678'
                },
                notes: {
                    customer: 'Please arrive on time'
                }
            },
            {
                _id: '2',
                bookingNumber: 'BK987654321',
                status: 'completed',
                serviceDetails: {
                    title: 'Fertilizer Application',
                    serviceType: 'fertilization'
                },
                booking: {
                    date: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000), // 7 days ago
                    time: '14:00'
                },
                pricing: {
                    currency: 'LKR',
                    finalAmount: 3500
                },
                payment: {
                    transactionId: 'TXN987654',
                    method: 'bank_transfer',
                    status: 'paid'
                },
                customer: {
                    _id: 'user1',
                    firstName: 'John',
                    lastName: 'Doe',
                    email: 'john@example.com'
                },
                serviceProvider: {
                    firstName: 'Another',
                    lastName: 'Provider',
                    email: 'another@example.com',
                    phone: '+94787654321'
                },
                notes: {
                    customer: 'Completed successfully'
                }
            }
        ];

        const mockUser = {
            _id: 'user1',
            firstName: 'John',
            lastName: 'Doe'
        };

        const OrdersPage = () => {
            const [bookings, setBookings] = useState(mockBookings);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [statusFilter, setStatusFilter] = useState('all');
            const [selectedBooking, setSelectedBooking] = useState(null);
            const [showModal, setShowModal] = useState(false);
            const [modalType, setModalType] = useState('');
            const [cancelReason, setCancelReason] = useState('');
            const [cancelling, setCancelling] = useState(false);
            const [updating, setUpdating] = useState(false);
            const [deleting, setDeleting] = useState(false);
            const [updateData, setUpdateData] = useState({
                date: '',
                time: '',
                notes: ''
            });

            const getStatusBadge = (status) => {
                const statusConfig = {
                    pending_confirmation: { bg: 'bg-yellow-100', text: 'text-yellow-800', icon: 'AlertCircle' },
                    confirmed: { bg: 'bg-blue-100', text: 'text-blue-800', icon: 'CheckCircle' },
                    in_progress: { bg: 'bg-purple-100', text: 'text-purple-800', icon: 'Clock' },
                    completed: { bg: 'bg-green-100', text: 'text-green-800', icon: 'CheckCircle' },
                    cancelled: { bg: 'bg-red-100', text: 'text-red-800', icon: 'XCircle' },
                    refunded: { bg: 'bg-gray-100', text: 'text-gray-800', icon: 'RefreshCw' }
                };

                const config = statusConfig[status] || statusConfig.pending_confirmation;

                return React.createElement('span', {
                    className: `inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${config.bg} ${config.text}`
                }, status.replace('_', ' ').toUpperCase());
            };

            const isUserCustomer = (booking) => {
                return booking.customer._id === mockUser._id;
            };

            const canUpdateBooking = (booking) => {
                if (['completed', 'cancelled', 'refunded', 'in_progress'].includes(booking.status)) {
                    return false;
                }

                const bookingDateTime = new Date(booking.booking.date);
                const [hours, minutes] = booking.booking.time.split(':');
                bookingDateTime.setHours(parseInt(hours), parseInt(minutes));
                
                const hoursUntilBooking = (bookingDateTime - new Date()) / (1000 * 60 * 60);
                return hoursUntilBooking >= 24;
            };

            const canCancelBooking = (booking) => {
                if (booking.status === 'cancelled' || booking.status === 'completed' || booking.status === 'refunded') {
                    return false;
                }

                const bookingDateTime = new Date(booking.booking.date);
                const [hours, minutes] = booking.booking.time.split(':');
                bookingDateTime.setHours(parseInt(hours), parseInt(minutes));
                
                const hoursUntilBooking = (bookingDateTime - new Date()) / (1000 * 60 * 60);
                return hoursUntilBooking >= 24;
            };

            const canDeleteBooking = (booking) => {
                return ['cancelled', 'completed', 'refunded'].includes(booking.status);
            };

            const handleUpdateBooking = async () => {
                setUpdating(true);
                // Mock API call
                setTimeout(() => {
                    alert('Booking updated successfully! (This is a demo)');
                    setUpdating(false);
                    setShowModal(false);
                    setSelectedBooking(null);
                    setUpdateData({ date: '', time: '', notes: '' });
                }, 1000);
            };

            const handleCancelBooking = async () => {
                setCancelling(true);
                // Mock API call
                setTimeout(() => {
                    alert('Booking cancelled successfully! (This is a demo)');
                    setCancelling(false);
                    setShowModal(false);
                    setSelectedBooking(null);
                    setCancelReason('');
                }, 1000);
            };

            const handleDeleteBooking = async () => {
                setDeleting(true);
                // Mock API call
                setTimeout(() => {
                    setBookings(prev => prev.filter(b => b._id !== selectedBooking._id));
                    alert('Booking deleted successfully! (This is a demo)');
                    setDeleting(false);
                    setShowModal(false);
                    setSelectedBooking(null);
                }, 1000);
            };

            const downloadReceipt = (booking) => {
                const receiptContent = `
AGRICULTURAL SERVICES RECEIPT
============================

Transaction ID: ${booking.payment.transactionId}
Booking Number: ${booking.bookingNumber}
Date: ${new Date(booking.payment.paidAt || Date.now()).toLocaleDateString()}

Service Details:
- Service: ${booking.serviceDetails.title}
- Type: ${booking.serviceDetails.serviceType}
- Date: ${new Date(booking.booking.date).toLocaleDateString()}
- Time: ${booking.booking.time}

Provider:
- Name: ${booking.serviceProvider.firstName} ${booking.serviceProvider.lastName}
- Email: ${booking.serviceProvider.email}
- Phone: ${booking.serviceProvider.phone}

Customer:
- Name: ${booking.customer.firstName} ${booking.customer.lastName}
- Email: ${booking.customer.email}

Payment:
- Amount: ${booking.pricing.currency} ${booking.pricing.finalAmount}
- Method: ${booking.payment.method.toUpperCase()}
- Status: ${booking.payment.status.toUpperCase()}

Status: ${booking.status.toUpperCase()}

Thank you for using our Agricultural Services platform!
                `;

                const blob = new Blob([receiptContent], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `receipt-${booking.bookingNumber}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            };

            return React.createElement('div', { className: 'container mx-auto px-4 py-8' }, [
                // Header
                React.createElement('div', { 
                    key: 'header',
                    className: 'flex justify-between items-center mb-6' 
                }, [
                    React.createElement('h1', { 
                        key: 'title',
                        className: 'text-3xl font-bold text-gray-800' 
                    }, 'My Bookings'),
                    React.createElement('button', {
                        key: 'refresh',
                        className: 'flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700'
                    }, 'Refresh')
                ]),

                // Filters
                React.createElement('div', { 
                    key: 'filters',
                    className: 'mb-6' 
                }, 
                    React.createElement('div', { className: 'flex items-center space-x-4' }, [
                        React.createElement('span', { 
                            key: 'icon',
                            className: 'w-5 h-5 text-gray-600' 
                        }, 'üîç'),
                        React.createElement('select', {
                            key: 'select',
                            value: statusFilter,
                            onChange: (e) => setStatusFilter(e.target.value),
                            className: 'border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent'
                        }, [
                            React.createElement('option', { key: 'all', value: 'all' }, 'All Bookings'),
                            React.createElement('option', { key: 'pending', value: 'pending_confirmation' }, 'Pending Confirmation'),
                            React.createElement('option', { key: 'confirmed', value: 'confirmed' }, 'Confirmed'),
                            React.createElement('option', { key: 'progress', value: 'in_progress' }, 'In Progress'),
                            React.createElement('option', { key: 'completed', value: 'completed' }, 'Completed'),
                            React.createElement('option', { key: 'cancelled', value: 'cancelled' }, 'Cancelled')
                        ])
                    ])
                ),

                // Error message
                error && React.createElement('div', {
                    key: 'error',
                    className: 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6'
                }, error),

                // Bookings list
                React.createElement('div', { 
                    key: 'bookings',
                    className: 'grid gap-6' 
                }, 
                    bookings.map((booking, index) => 
                        React.createElement('div', {
                            key: booking._id,
                            className: 'bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden'
                        }, 
                            React.createElement('div', { className: 'p-6' }, [
                                // Header
                                React.createElement('div', {
                                    key: 'header',
                                    className: 'flex justify-between items-start mb-4'
                                }, [
                                    React.createElement('div', { key: 'left' }, [
                                        React.createElement('h3', {
                                            key: 'title',
                                            className: 'text-xl font-semibold text-gray-800 mb-1'
                                        }, booking.serviceDetails.title),
                                        React.createElement('p', {
                                            key: 'number',
                                            className: 'text-gray-600 text-sm'
                                        }, `Booking #${booking.bookingNumber}`)
                                    ]),
                                    React.createElement('div', { 
                                        key: 'right',
                                        className: 'text-right' 
                                    }, [
                                        getStatusBadge(booking.status),
                                        React.createElement('p', {
                                            key: 'amount',
                                            className: 'text-lg font-bold text-gray-800 mt-1'
                                        }, `${booking.pricing.currency} ${booking.pricing.finalAmount}`)
                                    ])
                                ]),

                                // Details grid
                                React.createElement('div', {
                                    key: 'details',
                                    className: 'grid md:grid-cols-2 gap-4 mb-4'
                                }, [
                                    React.createElement('div', { 
                                        key: 'left-details',
                                        className: 'space-y-2' 
                                    }, [
                                        React.createElement('div', {
                                            key: 'date',
                                            className: 'flex items-center text-gray-600'
                                        }, `üìÖ ${new Date(booking.booking.date).toLocaleDateString()}`),
                                        React.createElement('div', {
                                            key: 'time',
                                            className: 'flex items-center text-gray-600'
                                        }, `üïê ${booking.booking.time}`),
                                        React.createElement('div', {
                                            key: 'payment',
                                            className: 'flex items-center text-gray-600'
                                        }, `üí≥ ${booking.payment.method.replace('_', ' ').toUpperCase()}`)
                                    ]),
                                    React.createElement('div', { 
                                        key: 'right-details',
                                        className: 'space-y-2' 
                                    }, [
                                        React.createElement('div', {
                                            key: 'provider',
                                            className: 'flex items-center text-gray-600'
                                        }, `üë§ Provider: ${booking.serviceProvider.firstName} ${booking.serviceProvider.lastName}`),
                                        React.createElement('div', {
                                            key: 'email',
                                            className: 'flex items-center text-gray-600'
                                        }, `‚úâÔ∏è ${booking.serviceProvider.email}`),
                                        React.createElement('div', {
                                            key: 'phone',
                                            className: 'flex items-center text-gray-600'
                                        }, `üìû ${booking.serviceProvider.phone || 'Not provided'}`)
                                    ])
                                ]),

                                // Actions
                                React.createElement('div', {
                                    key: 'actions',
                                    className: 'flex justify-between items-center pt-4 border-t border-gray-200'
                                }, [
                                    React.createElement('div', {
                                        key: 'transaction',
                                        className: 'text-sm text-gray-500'
                                    }, `Transaction ID: ${booking.payment.transactionId}`),
                                    React.createElement('div', {
                                        key: 'buttons',
                                        className: 'flex space-x-2'
                                    }, [
                                        // Receipt button
                                        React.createElement('button', {
                                            key: 'receipt',
                                            onClick: () => downloadReceipt(booking),
                                            className: 'flex items-center px-3 py-1 text-blue-600 border border-blue-600 rounded hover:bg-blue-50'
                                        }, 'üìÑ Receipt'),
                                        
                                        // Update button
                                        isUserCustomer(booking) && canUpdateBooking(booking) && React.createElement('button', {
                                            key: 'update',
                                            onClick: () => {
                                                setSelectedBooking(booking);
                                                setModalType('update');
                                                setUpdateData({
                                                    date: new Date(booking.booking.date).toISOString().split('T')[0],
                                                    time: booking.booking.time,
                                                    notes: booking.notes?.customer || ''
                                                });
                                                setShowModal(true);
                                            },
                                            className: 'flex items-center px-3 py-1 text-green-600 border border-green-600 rounded hover:bg-green-50'
                                        }, '‚úèÔ∏è Update'),
                                        
                                        // Cancel button
                                        isUserCustomer(booking) && canCancelBooking(booking) && React.createElement('button', {
                                            key: 'cancel',
                                            onClick: () => {
                                                setSelectedBooking(booking);
                                                setModalType('cancel');
                                                setShowModal(true);
                                            },
                                            className: 'flex items-center px-3 py-1 text-red-600 border border-red-600 rounded hover:bg-red-50'
                                        }, '‚ùå Cancel'),
                                        
                                        // Delete button
                                        isUserCustomer(booking) && canDeleteBooking(booking) && React.createElement('button', {
                                            key: 'delete',
                                            onClick: () => {
                                                setSelectedBooking(booking);
                                                setModalType('delete');
                                                setShowModal(true);
                                            },
                                            className: 'flex items-center px-3 py-1 text-gray-600 border border-gray-600 rounded hover:bg-gray-50'
                                        }, 'üóëÔ∏è Delete')
                                    ].filter(Boolean))
                                ])
                            ])
                        )
                    )
                ),

                // Modal
                showModal && selectedBooking && React.createElement('div', {
                    key: 'modal',
                    className: 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 modal-backdrop'
                }, 
                    React.createElement('div', {
                        className: 'bg-white rounded-lg max-w-md w-full p-6'
                    }, [
                        // Cancel Modal
                        modalType === 'cancel' && React.createElement('div', { key: 'cancel-content' }, [
                            React.createElement('h3', {
                                key: 'title',
                                className: 'text-lg font-semibold text-gray-800 mb-4'
                            }, 'Cancel Booking'),
                            React.createElement('p', {
                                key: 'message',
                                className: 'text-gray-600 mb-4'
                            }, `Are you sure you want to cancel this booking for "${selectedBooking.serviceDetails.title}"?`),
                            React.createElement('textarea', {
                                key: 'reason',
                                value: cancelReason,
                                onChange: (e) => setCancelReason(e.target.value),
                                placeholder: 'Please provide a reason for cancellation...',
                                className: 'w-full border border-gray-300 rounded-lg px-3 py-2 mb-4 focus:ring-2 focus:ring-blue-500 focus:border-transparent',
                                rows: 3
                            }),
                            React.createElement('div', {
                                key: 'buttons',
                                className: 'flex justify-end space-x-3'
                            }, [
                                React.createElement('button', {
                                    key: 'keep',
                                    onClick: () => {
                                        setShowModal(false);
                                        setSelectedBooking(null);
                                        setCancelReason('');
                                        setModalType('');
                                    },
                                    className: 'px-4 py-2 text-gray-600 border border-gray-300 rounded hover:bg-gray-50',
                                    disabled: cancelling
                                }, 'Keep Booking'),
                                React.createElement('button', {
                                    key: 'cancel-confirm',
                                    onClick: handleCancelBooking,
                                    disabled: cancelling || !cancelReason.trim(),
                                    className: 'px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed'
                                }, cancelling ? 'Cancelling...' : '‚ùå Cancel Booking')
                            ])
                        ]),

                        // Update Modal
                        modalType === 'update' && React.createElement('div', { key: 'update-content' }, [
                            React.createElement('h3', {
                                key: 'title',
                                className: 'text-lg font-semibold text-gray-800 mb-4'
                            }, 'Update Booking'),
                            React.createElement('p', {
                                key: 'message',
                                className: 'text-gray-600 mb-4'
                            }, `Update your booking details for "${selectedBooking.serviceDetails.title}"`),
                            React.createElement('div', {
                                key: 'form',
                                className: 'space-y-4'
                            }, [
                                React.createElement('div', { key: 'date-field' }, [
                                    React.createElement('label', {
                                        key: 'date-label',
                                        className: 'block text-sm font-medium text-gray-700 mb-1'
                                    }, 'Booking Date'),
                                    React.createElement('input', {
                                        key: 'date-input',
                                        type: 'date',
                                        value: updateData.date,
                                        onChange: (e) => setUpdateData(prev => ({ ...prev, date: e.target.value })),
                                        className: 'w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent',
                                        min: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString().split('T')[0]
                                    })
                                ]),
                                React.createElement('div', { key: 'time-field' }, [
                                    React.createElement('label', {
                                        key: 'time-label',
                                        className: 'block text-sm font-medium text-gray-700 mb-1'
                                    }, 'Booking Time'),
                                    React.createElement('input', {
                                        key: 'time-input',
                                        type: 'time',
                                        value: updateData.time,
                                        onChange: (e) => setUpdateData(prev => ({ ...prev, time: e.target.value })),
                                        className: 'w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent'
                                    })
                                ]),
                                React.createElement('div', { key: 'notes-field' }, [
                                    React.createElement('label', {
                                        key: 'notes-label',
                                        className: 'block text-sm font-medium text-gray-700 mb-1'
                                    }, 'Notes (Optional)'),
                                    React.createElement('textarea', {
                                        key: 'notes-input',
                                        value: updateData.notes,
                                        onChange: (e) => setUpdateData(prev => ({ ...prev, notes: e.target.value })),
                                        placeholder: 'Add any special instructions or notes...',
                                        className: 'w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent',
                                        rows: 3
                                    })
                                ])
                            ]),
                            React.createElement('div', {
                                key: 'buttons',
                                className: 'flex justify-end space-x-3 mt-6'
                            }, [
                                React.createElement('button', {
                                    key: 'cancel',
                                    onClick: () => {
                                        setShowModal(false);
                                        setSelectedBooking(null);
                                        setUpdateData({ date: '', time: '', notes: '' });
                                        setModalType('');
                                    },
                                    className: 'px-4 py-2 text-gray-600 border border-gray-300 rounded hover:bg-gray-50',
                                    disabled: updating
                                }, 'Cancel'),
                                React.createElement('button', {
                                    key: 'update',
                                    onClick: handleUpdateBooking,
                                    disabled: updating,
                                    className: 'px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed'
                                }, updating ? 'Updating...' : '‚úèÔ∏è Update Booking')
                            ])
                        ]),

                        // Delete Modal
                        modalType === 'delete' && React.createElement('div', { key: 'delete-content' }, [
                            React.createElement('h3', {
                                key: 'title',
                                className: 'text-lg font-semibold text-gray-800 mb-4'
                            }, 'Delete Booking'),
                            React.createElement('p', {
                                key: 'message',
                                className: 'text-gray-600 mb-4'
                            }, `Are you sure you want to permanently delete this booking for "${selectedBooking.serviceDetails.title}"? This action cannot be undone.`),
                            React.createElement('div', {
                                key: 'warning',
                                className: 'bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4'
                            }, 
                                React.createElement('p', {
                                    className: 'text-yellow-800 text-sm'
                                }, React.createElement('strong', {}, 'Warning: '), 'This will permanently remove the booking from your records.')
                            ),
                            React.createElement('div', {
                                key: 'buttons',
                                className: 'flex justify-end space-x-3'
                            }, [
                                React.createElement('button', {
                                    key: 'keep',
                                    onClick: () => {
                                        setShowModal(false);
                                        setSelectedBooking(null);
                                        setModalType('');
                                    },
                                    className: 'px-4 py-2 text-gray-600 border border-gray-300 rounded hover:bg-gray-50',
                                    disabled: deleting
                                }, 'Keep Booking'),
                                React.createElement('button', {
                                    key: 'delete-confirm',
                                    onClick: handleDeleteBooking,
                                    disabled: deleting,
                                    className: 'px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed'
                                }, deleting ? 'Deleting...' : 'üóëÔ∏è Delete Booking')
                            ])
                        ])
                    ])
                )
            ]);
        };

        ReactDOM.render(React.createElement(OrdersPage), document.getElementById('root'));
    </script>
</body>
</html>